<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Scanner WebAR + Foto</title>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; color: white; }
        
        /* -- TELAS -- */
        #scanner-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        #ar-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 5; background: black;
        }

        /* -- UI SCANNER -- */
        #reader { width: 100%; max-width: 400px; border-radius: 10px; overflow: hidden; }
        .titulo { color: black; font-size: 24px; margin-bottom: 10px; }
        .aviso { color: #555; text-align: center; margin-bottom: 20px; padding: 0 20px; }
        
        /* -- UI DO AR (Botão de Foto) -- */
        #ar-ui {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            z-index: 20; display: none; /* Escondido até carregar */
            flex-direction: column; align-items: center; justify-content: center;
            pointer-events: none; /* Deixa clicar no 3D atrás se precisar */
        }

        /* O Botão Estilo Instagram */
        #btn-foto {
            pointer-events: auto;
            width: 70px; height: 70px;
            background-color: white;
            border: 4px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        #btn-foto:active { transform: scale(0.9); background-color: #ddd; }

        /* Mensagem de Feedback */
        #msg-feedback {
            background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px;
            margin-bottom: 15px; font-size: 14px; opacity: 0; transition: opacity 0.5s;
        }
        
        /* Aviso de Carregamento */
        #ar-loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px;
            color: white; font-size: 16px; z-index: 6; display: none; text-align: center;
        }
    </style>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-face-aframe.prod.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

    <div id="scanner-container">
        <h1 class="titulo">COsecurity AR</h1>
        <p class="aviso">Aponte para o QR Code #COSECURITYAR</p>
        <div id="reader"></div>
        <p id="status" style="color:gray; margin-top:15px; font-size: 14px;">Aguardando...</p>
    </div>

    <div id="ar-container">
        <div id="ar-loading">Carregando Filtro...</div>
        
        <div id="ar-ui">
            <div id="msg-feedback">Foto salva! Abrindo Instagram...</div>
            <button id="btn-foto" onclick="tirarFoto()"></button>
        </div>
    </div>

    <script>
        // CONFIGURAÇÕES
        // Link do Modelo (Capacete de exemplo, troque pelo seu bone .glb)
        const URL_DO_MODELO = "https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb";
        const ESCALA_INICIAL = "1 1 1"; 
        const POSICAO_INICIAL = "0 -0.4 0"; 

        const scannerContainer = document.getElementById('scanner-container');
        const arContainer = document.getElementById('ar-container');
        const arLoading = document.getElementById('ar-loading');
        const arUI = document.getElementById('ar-ui');
        const statusMsg = document.getElementById('status');
        let html5QrCode;
        let scannerAtivo = true;

        // --- 1. SCANNER ---
        function iniciarScanner() {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    if (scannerAtivo && decodedText) {
                        scannerAtivo = false;
                        statusMsg.innerText = "Sucesso! Iniciando...";
                        statusMsg.style.color = "green";
                        arLoading.style.display = 'block';
                        setTimeout(ativarModoAR, 800);
                    }
                },
                () => {}
            ).catch(err => { statusMsg.innerText = "Erro Câmera: " + err; });
        }

        // --- 2. TRANSIÇÃO ---
        function ativarModoAR() {
            html5QrCode.stop().then(() => {
                scannerContainer.style.display = 'none';
                renderizarCenaAR();
            }).catch(err => console.error(err));
        }

        // --- 3. CENA AR ---
        function renderizarCenaAR() {
            // Nota Crítica: preserveDrawingBuffer: true é OBRIGATÓRIO para tirar print
            arContainer.innerHTML = `
                <a-scene mindar-face embedded color-space="sRGB" 
                    renderer="colorManagement: true, physicallyCorrectLights, preserveDrawingBuffer: true" 
                    vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
                    
                    <a-assets>
                        <a-asset-item id="meuModelo" src="${URL_DO_MODELO}"></a-asset-item>
                    </a-assets>

                    <a-camera active="false" position="0 0 0"></a-camera>
                    
                    <a-entity mindar-face-target="anchorIndex: 10">
                        <a-gltf-model src="#meuModelo" position="${POSICAO_INICIAL}" scale="${ESCALA_INICIAL}" rotation="0 180 0"></a-gltf-model>
                    </a-entity>
                </a-scene>
            `;

            document.querySelector('a-scene').addEventListener('mindar-face-ready', () => {
                arLoading.style.display = 'none';
                arUI.style.display = 'flex'; // Mostra o botão de foto
                console.log("AR Pronto!");
            });
        }

        // --- 4. SISTEMA DE FOTO E INSTAGRAM ---
        function tirarFoto() {
            const scene = document.querySelector('a-scene');
            const video = document.querySelector('video'); // O vídeo da webcam do MindAR
            const canvas3D = scene.components.screenshot.getCanvas('perspective'); // O 3D

            // Cria um canvas temporário para mesclar as duas imagens
            const canvasFinal = document.createElement('canvas');
            canvasFinal.width = video.videoWidth;
            canvasFinal.height = video.videoHeight;
            const ctx = canvasFinal.getContext('2d');

            // 1. Desenha o vídeo espelhado (como num espelho)
            ctx.save();
            ctx.scale(-1, 1); // Inverte horizontalmente
            ctx.drawImage(video, -canvasFinal.width, 0, canvasFinal.width, canvasFinal.height);
            ctx.restore();

            // 2. Desenha o 3D por cima
            ctx.drawImage(canvas3D, 0, 0, canvasFinal.width, canvasFinal.height);

            // 3. Baixa a imagem
            const dataURL = canvasFinal.toDataURL('image/png');
            downloadImage(dataURL, 'minha-foto-ar.png');

            // 4. Feedback e Redirecionamento
            const feedback = document.getElementById('msg-feedback');
            feedback.style.opacity = 1;
            
            setTimeout(() => {
                // Tenta abrir o app do Instagram
                // Nota: Em alguns celulares vai para a loja ou home se o app não responder ao link universal
                window.location.href = "instagram://camera"; 
                
                // Fallback: Se não abrir em 1seg, avisa o usuário
                setTimeout(() => {
                    feedback.innerText = "Abra o Instagram e poste a foto da galeria!";
                }, 2000);
            }, 1500);
        }

        function downloadImage(data, filename) {
            const a = document.createElement('a');
            a.href = data;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        iniciarScanner();

    </script>
</body>
</html>
