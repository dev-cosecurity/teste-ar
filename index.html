<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cosecurity Street Stocagem</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* === ESTILOS BÁSICOS === */
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }
        
        /* === TELA 1: SCANNER === */
        #scanner-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: #00ffff;
        }
        #reader { width: 300px; height: 300px; border: 2px solid #00ffff; }
        
        /* === TELA 2: AR FULLSCREEN === */
        /* O A-Frame cuida do vídeo em tela cheia automaticamente */
        #ar-ui {
            position: absolute; top: 20px; left: 0; width: 100%;
            text-align: center; pointer-events: none; z-index: 20;
        }
        .instrucao {
            color: #fff; background: rgba(0,0,0,0.5); padding: 10px 20px;
            border-radius: 20px; font-size: 14px; text-transform: uppercase;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
    </style>

    <script>
        // === COMPONENTE SPAWNER (A MÁGICA DO CLIQUE) ===
        AFRAME.registerComponent('click-spawner', {
            init: function () {
                // Escuta cliques em qualquer lugar da cena
                this.el.sceneEl.addEventListener('click', (evt) => {
                    // 'evt.detail.intersection' contém os dados de onde o raio do clique bateu no mundo 3D
                    if (evt.detail.intersection) {
                        const point = evt.detail.intersection.point;
                        spawnPoste(point);
                    }
                });
            }
        });

        // Função que cria o elemento do poste
        function spawnPoste(positionPoint) {
            const scene = document.querySelector('a-scene');
            
            // 1. Cria o elemento de imagem
            const poste = document.createElement('a-image');
            
            // 2. Configurações do Poste (IMPORTANTE AJUSTAR AQUI)
            poste.setAttribute('src', '#img-poste');
            poste.setAttribute('width', '1');   // Largura real em metros (ex: 1 metro)
            poste.setAttribute('height', '3');  // Altura real em metros (ex: 3 metros)
            
            // 3. Define a posição onde foi clicado
            // Ajustamos o Y (altura) para metade da altura do objeto, para ele ficar apoiado no ponto clicado e não enterrado no meio
            poste.setAttribute('position', `${positionPoint.x} ${positionPoint.y + 1.5} ${positionPoint.z}`);
            
            // 4. CRUCIAL: Faz o PNG sempre girar para encarar o usuário
            poste.setAttribute('look-at', '[camera]');

            // 5. Animação de "Pop" ao aparecer
            poste.setAttribute('scale', '0 0 0');
            poste.setAttribute('animation', 'property: scale; to: 1 1 1; dur: 600; easing: easeOutBack');

            // Adiciona à cena
            scene.appendChild(poste);
        }
    </script>
</head>
<body>

    <div id="scanner-overlay">
        <h2>SCAN QR CODE</h2>
        <div id="reader"></div>
    </div>

    <div id="ar-ui" style="display: none;">
        <span class="instrucao">Toque na tela para posicionar um poste</span>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false" 
             cursor="rayOrigin: mouse" 
             raycaster="objects: .clicavel"
             click-spawner>

        <a-assets>
            <img id="img-poste" src="./poste-virtual.png">
        </a-assets>

        <a-camera position="0 1.6 0" look-controls="enabled: true"></a-camera>

        <a-sphere class="clicavel" radius="10" position="0 1.6 0" 
                  material="opacity: 0; side: back; shader: flat">
        </a-sphere>

        <a-light type="ambient" intensity="1"></a-light>

    </a-scene>

    <script>
        // === LÓGICA DO SCANNER ===
        const scannerOverlay = document.getElementById('scanner-overlay');
        const arUI = document.getElementById('ar-ui');
        let html5QrCode;
        let scannerAtivo = true;

        function iniciarScanner() {
            html5QrCode = new Html5Qrcode("reader");
            // facingMode: "environment" força a câmera traseira
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    if (scannerAtivo) {
                        console.log("QR Lido:", decodedText);
                        // (Opcional) Valide o texto do QR Code aqui se quiser
                        
                        scannerAtivo = false;
                        qrCodeLidoComSucesso();
                    }
                },
                () => {} // Ignora erros de leitura por frame
            ).catch(err => {
                alert("Erro ao iniciar câmera: " + err);
            });
        }

        function qrCodeLidoComSucesso() {
            html5QrCode.stop().then(() => {
                // Esconde o scanner
                scannerOverlay.style.display = 'none';
                // Mostra a UI de instrução do AR
                arUI.style.display = 'block';
                
                // O A-Frame assume a câmera traseira automaticamente e fica em fullscreen.
            }).catch(err => console.error(err));
        }

        // Script de placeholder caso você não tenha o arquivo 'poste-virtual.png' na pasta ainda.
        // REMOVA ISSO QUANDO COLOCAR SEU ARQUIVO REAL.
        const img = document.getElementById('logo3.png');
        img.onerror = () => {
            img.src = "https://via.placeholder.com/300x800/0000ff/ffffff?text=POSTE+PNG";
        };

        // Inicia o fluxo
        iniciarScanner();
    </script>
</body>
</html>
