<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosecurity MediaPipe Core</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        /* Mantendo sua estética Cyberpunk */
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        
        #main-container { position: relative; width: 100vw; height: 100vh; }
        
        /* O vídeo fica escondido ou visível por baixo, mas o canvas é quem manda */
        #input-video { position: absolute; transform: scaleX(-1); width: 100%; height: 100%; object-fit: cover; opacity: 0; } 
        #output-canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; }

        .ui-layer {
            position: absolute; top: 20px; left: 20px; color: #00ffff;
            text-shadow: 0 0 10px #00ffff; z-index: 10; pointer-events: none;
        }

        #debug-info {
            background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #00ffff;
        }

        .scanline {
            position: absolute; width: 100%; height: 5px; background: rgba(0, 255, 255, 0.3);
            animation: scan 3s linear infinite; pointer-events: none; z-index: 5;
        }

        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
    </style>
</head>
<body>

<div id="main-container">
    <video id="input-video" playsinline></video>
    <canvas id="output-canvas"></canvas>
    <div class="scanline"></div>

    <div class="ui-layer">
        <h2>COSECURITY_KERNEL</h2>
        <div id="debug-info">INIT SYSTEM...</div>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input-video');
    const canvasElement = document.getElementById('output-canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const debugElement = document.getElementById('debug-info');

    // Carregar a imagem da coroa (Substitua pela URL do seu asset 2D ou render do 3D)
    const crownImage = new Image();
    crownImage.src = "https://cdn-icons-png.flaticon.com/512/1165/1165239.png"; // Exemplo placeholder

    // Ajuste de DPI para nitidez
    function resizeCanvas() {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function onResults(results) {
        // Limpar canvas
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        // Desenhar o vídeo da câmera no canvas (espelhado)
        canvasCtx.translate(canvasElement.width, 0);
        canvasCtx.scale(-1, 1);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.multiFaceLandmarks) {
            for (const landmarks of results.multiFaceLandmarks) {
                // AQUI ACONTECE A MÁGICA MATEMÁTICA
                processarFace(landmarks);
            }
            debugElement.innerHTML = `TARGETS: ${results.multiFaceLandmarks.length} <br> STATUS: LOCKED`;
        } else {
            debugElement.innerHTML = "SEARCHING...";
        }
        canvasCtx.restore();
    }

    function processarFace(landmarks) {
        // Pontos chaves do MediaPipe FaceMesh
        // 10: Topo da testa central
        // 152: Queixo
        // 234: Têmpora esquerda (na visão da câmera espelhada é direita)
        // 454: Têmpora direita

        const pTopo = landmarks[10];
        const pEsq = landmarks[234];
        const pDir = landmarks[454];

        // Converter coordenadas normalizadas (0 a 1) para pixels
        const width = canvasElement.width;
        const height = canvasElement.height;

        const x = pTopo.x * width;
        const y = pTopo.y * height;
        
        // 1. Calcular Rotação (Roll) baseada nas têmporas
        // Math.atan2(dy, dx) nos dá o ângulo em radianos
        const dy = (pDir.y - pEsq.y) * height;
        const dx = (pDir.x - pEsq.x) * width;
        const angle = Math.atan2(dy, dx);

        // 2. Calcular Escala baseada na distância das têmporas (Euclidiana simples)
        const dist = Math.sqrt(dx*dx + dy*dy);
        const scaleMultiplier = 2.5; // Ajuste fino: quão grande a coroa deve ser em relação à cabeça
        const crownWidth = dist * scaleMultiplier;
        const crownHeight = crownWidth * (crownImage.height / crownImage.width);

        // 3. Renderizar com Transformação Matrix
        canvasCtx.save();
        
        // Mover o "ponto zero" para a testa
        canvasCtx.translate(x, y); 
        
        // Rotacionar
        canvasCtx.rotate(angle);
        
        // Ajuste fino de posição Y (Offset) para a coroa flutuar um pouco acima
        const yOffset = -crownHeight * 0.8; 
        
        // Desenhar imagem centralizada no novo eixo
        canvasCtx.drawImage(crownImage, -crownWidth/2, yOffset, crownWidth, crownHeight);
        
        // Opcional: Efeito Cyberpunk (Glow Box na face)
        // desenharHUD(canvasCtx, crownWidth, crownHeight, yOffset);

        canvasCtx.restore();
    }

    // Configuração do MediaPipe
    const faceMesh = new FaceMesh({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }});

    faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    faceMesh.onResults(onResults);

    // Inicializar Câmera
    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await faceMesh.send({image: videoElement});
        },
        width: 1280,
        height: 720
    });
    camera.start();

</script>
</body>
</html>
