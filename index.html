<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner WebAR Final</title>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; color: white; }
        
        /* Container do Scanner (Tela 1) */
        #scanner-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        /* Container da Realidade Aumentada (Tela 2) */
        #ar-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 5; background: black;
        }
        
        /* UI do Scanner */
        #reader { width: 100%; max-width: 400px; border-radius: 10px; overflow: hidden; }
        .titulo { color: black; font-size: 24px; margin-bottom: 10px; }
        .aviso { color: #555; text-align: center; margin-bottom: 20px; padding: 0 20px; }
        
        /* Aviso de Carregamento do 3D */
        #ar-loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px;
            color: white; font-size: 16px; z-index: 6; display: none; text-align: center;
        }
    </style>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-aframe.prod.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

    <div id="scanner-container">
        <h1 class="titulo">Scanner AR</h1>
        <p class="aviso">Aponte a câmera para o QR Code para liberar o filtro.</p>
        <div id="reader"></div>
        <p id="status" style="color:gray; margin-top:15px; font-size: 14px;">Iniciando sistema...</p>
    </div>

    <div id="ar-container">
        <div id="ar-loading">
            Detectando QR Code...<br>
            <span style="font-size:12px">Baixando modelo 3D...</span>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÕES GERAIS ---
        
        // 1. O Link do seu modelo 3D. 
        // Para testar, use este capacete oficial. Depois, explicarei como trocar.
        const URL_DO_MODELO = "https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb";
        
        // 2. Ajustes de Posição (Calibragem)
        // Se ficar muito grande, diminua para 0.1 0.1 0.1
        // Se ficar muito pequeno, aumente para 10 10 10
        const ESCALA_INICIAL = "1 1 1"; 
        
        // Ajuste Y (segundo número): Negativo desce, Positivo sobe.
        const POSICAO_INICIAL = "0 -0.3 0"; 

        // -----------------------------

        const scannerContainer = document.getElementById('scanner-container');
        const arContainer = document.getElementById('ar-container');
        const arLoading = document.getElementById('ar-loading');
        const statusMsg = document.getElementById('status');
        let html5QrCode;
        let scannerAtivo = true;

        // INICIALIZAÇÃO
        function iniciarScanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            // Tenta usar câmera traseira (environment)
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, 
                onScanSuccess, 
                onScanFailure
            ).catch(err => {
                statusMsg.innerText = "Erro de Permissão: " + err;
                statusMsg.style.color = "red";
            });
        }

        // QUANDO O QR CODE É LIDO
        function onScanSuccess(decodedText) {
            if (scannerAtivo && decodedText) {
                // Aqui você pode colocar: if (decodedText === "SEU_LINK_ESPECIFICO")
                
                scannerAtivo = false; // Trava para não ler 2 vezes
                statusMsg.innerText = "QR Code Detectado! Abrindo AR...";
                statusMsg.style.color = "green";
                
                // Mostra aviso de carregamento
                arLoading.style.display = 'block';

                // Pequeno delay para UX (feedback visual)
                setTimeout(ativarModoAR, 800);
            }
        }

        function onScanFailure(error) {
            // Não fazemos nada aqui para não poluir o console, pois ele falha a cada frame que não vê QR
        }

        // A MÁGICA: TROCAR DE SCANNER PARA AR
        function ativarModoAR() {
            // 1. Para a câmera do QR Code (Libera o hardware)
            html5QrCode.stop().then(() => {
                scannerContainer.style.display = 'none'; // Some com a tela 1
                
                // 2. Injeta o código do MindAR na tela 2
                renderizarCenaAR();
                
            }).catch(err => {
                console.error("Erro ao parar scanner", err);
            });
        }

        function renderizarCenaAR() {
            arContainer.innerHTML = `
                <a-scene mindar-face embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
                    
                    <a-assets>
                        <a-asset-item id="meuModelo" src="${URL_DO_MODELO}"></a-asset-item>
                    </a-assets>

                    <a-camera active="false" position="0 0 0"></a-camera>
                    
                    <a-entity mindar-face-target="anchorIndex: 10">
                        <a-gltf-model 
                            src="#meuModelo" 
                            position="${POSICAO_INICIAL}" 
                            scale="${ESCALA_INICIAL}" 
                            rotation="0 180 0">
                        </a-gltf-model>
                    </a-entity>

                </a-scene>
            `;

            // Quando o modelo 3D terminar de baixar e o rosto for detectado:
            document.querySelector('a-scene').addEventListener('mindar-face-ready', () => {
                arLoading.style.display = 'none'; // Some com o aviso "Carregando"
                console.log("AR Pronto!");
            });
        }

        // Começa tudo
        iniciarScanner();

    </script>
</body>
</html>
